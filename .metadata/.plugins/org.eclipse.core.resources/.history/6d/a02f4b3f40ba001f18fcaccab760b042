package dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.sql.Statement;
import model.Roomtype;

public class RoomTypeDAO {

    private final Connection connection;

    public RoomTypeDAO() {
        connection = SingleConnection.getInstance();
    }

    // Add a new room type and associate it with a hotel
    public boolean addRoomType(Roomtype roomType, int hotelId) throws SQLException {
        String sqlRoomType = "INSERT INTO hotel.roomtype (label, capacity, prix) VALUES (?, ?, ?)";
        String sqlHotelRoom = "INSERT INTO hotel.hotelroom (hotel_id, room_type_id) VALUES (?, ?)";

        try (
            PreparedStatement statementRoomType = connection.prepareStatement(sqlRoomType, Statement.RETURN_GENERATED_KEYS);
            PreparedStatement statementHotelRoom = connection.prepareStatement(sqlHotelRoom)
        ) {
            // Insert into roomtype table
            statementRoomType.setString(1, roomType.getLabel());
            statementRoomType.setInt(2, roomType.getCapacity());
            statementRoomType.setInt(3, roomType.getPrix());

            int rowsAffected = statementRoomType.executeUpdate();

            if (rowsAffected > 0) {
                try (ResultSet generatedKeys = statementRoomType.getGeneratedKeys()) {
                    if (generatedKeys.next()) {
                        int roomTypeId = generatedKeys.getInt(1);

                        // Insert into hotelroom table
                        statementHotelRoom.setInt(1, hotelId);
                        statementHotelRoom.setInt(2, roomTypeId);

                        return statementHotelRoom.executeUpdate() > 0;
                    }
                }
            }
        }
        return false;
    }

    public boolean updateRoomTypeAndHotel(int roomTypeId, String label, int capacity, double price, int hotelId) {
   
        PreparedStatement updateRoomTypeStmt = null;
        PreparedStatement updateHotelRoomStmt = null;

        try {
          
            connection.setAutoCommit(false); // Transaction management

            // Mettre à jour la table `roomtype`
            String updateRoomTypeSQL = "UPDATE roomtype SET label = ?, capacity = ?, price = ? WHERE id = ?";
            updateRoomTypeStmt = connection.prepareStatement(updateRoomTypeSQL);
            updateRoomTypeStmt.setString(1, label);
            updateRoomTypeStmt.setInt(2, capacity);
            updateRoomTypeStmt.setDouble(3, price);
            updateRoomTypeStmt.setInt(4, roomTypeId);
            updateRoomTypeStmt.executeUpdate();

            // Mettre à jour la table `hotelroom`
            String updateHotelRoomSQL = "UPDATE hotelroom SET hotel_id = ? WHERE room_type_id = ?";
            updateHotelRoomStmt = connection.prepareStatement(updateHotelRoomSQL);
            updateHotelRoomStmt.setInt(1, hotelId);
            updateHotelRoomStmt.setInt(2, roomTypeId);
            updateHotelRoomStmt.executeUpdate();

            // Commit transaction
            connection.commit();
            return true;

        } catch (SQLException e) {
            if (connection != null) {
                try {
                    connection.rollback(); // Annuler en cas d'erreur
                } catch (SQLException rollbackEx) {
                    rollbackEx.printStackTrace();
                }
            }
            e.printStackTrace();
            return false;
        } finally {
            // Fermer les ressources
            try {
                if (updateRoomTypeStmt != null) updateRoomTypeStmt.close();
                if (updateHotelRoomStmt != null) updateHotelRoomStmt.close();
                if (connection != null) connection.close();
            } catch (SQLException closeEx) {
                closeEx.printStackTrace();
            }
        }
    }


    // Delete a room type by ID
    public boolean deleteRoomType(int roomTypeId) throws SQLException {
        String sql = "DELETE FROM hotel.roomtype WHERE id = ?";
        try (PreparedStatement statement = connection.prepareStatement(sql)) {
            statement.setInt(1, roomTypeId);
            return statement.executeUpdate() > 0;
        }
    }

    // Retrieve all room types
    public List<Roomtype> getAllRoomTypes() throws SQLException {
        String sql = "SELECT * FROM hotel.roomtype";
        List<Roomtype> roomTypes = new ArrayList<>();

        try (
            PreparedStatement statement = connection.prepareStatement(sql);
            ResultSet resultSet = statement.executeQuery()
        ) {
            while (resultSet.next()) {
                Roomtype roomType = new Roomtype(
                    resultSet.getInt("id"),
                    resultSet.getString("label"),
                    resultSet.getInt("capacity"),
                    resultSet.getInt("prix")
                );
                roomTypes.add(roomType);
            }
        }
        return roomTypes;
    }

    // Retrieve a room type by ID
    public Roomtype getRoomTypeById(int roomTypeId) throws SQLException {
        String sql = "SELECT * FROM hotel.roomtype WHERE id = ?";
        try (PreparedStatement statement = connection.prepareStatement(sql)) {
            statement.setInt(1, roomTypeId);

            try (ResultSet resultSet = statement.executeQuery()) {
                if (resultSet.next()) {
                    return new Roomtype(
                        resultSet.getInt("id"),
                        resultSet.getString("label"),
                        resultSet.getInt("capacity"),
                        resultSet.getInt("prix")
                    );
                }
            }
        }
        return null;
    }

    // Retrieve all room types associated with a specific hotel
    public List<Roomtype> getRoomTypesByHotelId(int hotelId) throws SQLException {
        String sql = "SELECT rt.* FROM hotel.roomtype rt " +
                     "JOIN hotel.hotelroom hr ON rt.id = hr.room_type_id " +
                     "WHERE hr.hotel_id = ?";
        List<Roomtype> roomTypes = new ArrayList<>();

        try (PreparedStatement statement = connection.prepareStatement(sql)) {
            statement.setInt(1, hotelId);

            try (ResultSet resultSet = statement.executeQuery()) {
                while (resultSet.next()) {
                    Roomtype roomType = new Roomtype(
                        resultSet.getInt("id"),
                        resultSet.getString("label"),
                        resultSet.getInt("capacity"),
                        resultSet.getInt("prix")
                    );
                    roomTypes.add(roomType);
                }
            }
        }
        return roomTypes;
    }
}
