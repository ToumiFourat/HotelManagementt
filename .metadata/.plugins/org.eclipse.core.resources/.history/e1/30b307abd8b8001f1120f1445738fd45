package dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import model.Hotel;
import model.Roomtype;
import model.HotelRoom;

public class HotelRoomDAO {

    private Connection connection;

    public HotelRoomDAO() {
        connection = SingleConnection.getInstance();
    }

    public List<Hotel> getHotelsWithRoomTypes(String city, int stars, String roomTypeLabel, int capacity, double minPrice, double maxPrice) throws SQLException {
        List<Hotel> hotels = new ArrayList<>();

        String sql = """
            SELECT h.id AS hotel_id, h.name AS hotel_name, h.city, h.stars, h.description, h.image,
                   rt.id AS room_type_id, rt.label AS room_type_label, rt.capacity, rt.prix
            FROM hotel.hotel h
            INNER JOIN hotelroom hr ON h.id = hr.hotel_id
            INNER JOIN roomtype rt ON hr.room_type_id = rt.id
            WHERE h.city = ? AND h.stars = ? AND rt.label = ? AND rt.capacity >= ? AND rt.prix BETWEEN ? AND ?
        """;

        try (PreparedStatement statement = connection.prepareStatement(sql)) {
            statement.setString(1, city);
            statement.setInt(2, stars);
            statement.setString(3, roomTypeLabel);
            statement.setInt(4, capacity);
            statement.setDouble(5, minPrice);
            statement.setDouble(6, maxPrice);

            try (ResultSet rs = statement.executeQuery()) {
                Map<Integer, Hotel> hotelMap = new HashMap<>();

                while (rs.next()) {
                    int hotelId = rs.getInt("hotel_id");

                    // Vérifier si l'hôtel existe déjà dans la map
                    Hotel hotel = hotelMap.get(hotelId);
                    if (hotel == null) {
                        hotel = new Hotel();
                        hotel.setId(hotelId);
                        hotel.setName(rs.getString("hotel_name"));
                        hotel.setCity(rs.getString("city"));
                        hotel.setStars(rs.getInt("stars"));
                        hotel.setDescription(rs.getString("description"));
                        hotel.setImage(rs.getString("image"));
                        hotelMap.put(hotelId, hotel);
                    }

                    // Mapper Roomtype
                    Roomtype roomType = new Roomtype();
                    roomType.setId(rs.getInt("room_type_id"));
                    roomType.setLabel(rs.getString("room_type_label"));
                    roomType.setCapacity(rs.getInt("capacity"));
                    roomType.getPrix();

                    hotel.addRoomType(roomType);
                }

                hotels.addAll(hotelMap.values());
            }
        }

        return hotels;
    }
}
